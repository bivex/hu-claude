#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º–æ–π —Å–∞–º–æ—Å–æ–≤–µ—Ä—à–µ–Ω—Å—Ç–≤–æ–≤–∞–Ω–∏—è

show_help() {
    echo "üß† –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–æ–π —Å–∞–º–æ—Å–æ–≤–µ—Ä—à–µ–Ω—Å—Ç–≤–æ–≤–∞–Ω–∏—è"
    echo ""
    echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 [–∫–æ–º–∞–Ω–¥–∞]"
    echo ""
    echo "–ö–æ–º–∞–Ω–¥—ã:"
    echo "  setup     - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏"
    echo "  generate  - –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ (–Ω—É–∂–Ω–∞ –¥–∞—Ç–∞/–≤—Ä–µ–º—è)"
    echo "  export    - –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –≤ ICS"
    echo "  status    - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã"
    echo "  help      - –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É"
    echo ""
    echo "–ü—Ä–∏–º–µ—Ä—ã:"
    echo "  $0 setup"
    echo "  $0 generate '16 —Ñ–µ–≤—Ä–∞–ª—è 2026 –≥–æ–¥–∞ –≤ 8:00'"
    echo "  $0 export"
}

setup_venv() {
    echo "üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è..."

    if [ ! -d "venv" ]; then
        python3 -m venv venv
        echo "‚úÖ –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ"
    else
        echo "‚ÑπÔ∏è  –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
    fi

    source venv/bin/activate
    pip install icalendar pytz pyyaml
    echo "‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
}

generate_schedule() {
    if [ -z "$1" ]; then
        echo "‚ùå –£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞"
        echo "–ü—Ä–∏–º–µ—Ä: $0 generate '16 —Ñ–µ–≤—Ä–∞–ª—è 2026 –≥–æ–¥–∞ –≤ 8:00'"
        exit 1
    fi

    echo "üìÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è: $1"

    if [ ! -d "venv" ]; then
        echo "‚ùå –°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ: $0 setup"
        exit 1
    fi

    source venv/bin/activate
    python3 generate_schedule.py "$1"
}

export_ics() {
    echo "üì§ –≠–∫—Å–ø–æ—Ä—Ç —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –≤ ICS..."

    if [ ! -d "venv" ]; then
        echo "‚ùå –°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ: $0 setup"
        exit 1
    fi

    if [ ! -f "schedule/weekly-schedule.yaml" ]; then
        echo "‚ùå –°–Ω–∞—á–∞–ª–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ"
        exit 1
    fi

    source venv/bin/activate
    python3 export_ics.py
}

check_status() {
    echo "üìä –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã:"
    echo ""

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
    if [ -d "venv" ]; then
        echo "‚úÖ –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ: –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ"
    else
        echo "‚ùå –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ: –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ"
    fi

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
    if [ -f "schedule/weekly-schedule.yaml" ]; then
        echo "‚úÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ: —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ"
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞
        start_date=$(grep "start_date:" schedule/weekly-schedule.yaml | cut -d"'" -f2)
        if [ ! -z "$start_date" ]; then
            echo "üìÖ –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞: $start_date"
        fi
    else
        echo "‚ùå –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ: –Ω–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ"
    fi

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º ICS
    if [ -f "schedule/weekly-schedule.ics" ]; then
        echo "‚úÖ ICS —ç–∫—Å–ø–æ—Ä—Ç: –≥–æ—Ç–æ–≤"
    else
        echo "‚ùå ICS —ç–∫—Å–ø–æ—Ä—Ç: –Ω–µ –≥–æ—Ç–æ–≤"
    fi

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤
    skills_count=$(find .claude/skills -name "SKILL.md" | wc -l)
    echo "üë• –°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤: $skills_count –∏–∑ 22"

    echo ""
    echo "üí° –î–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã:"
    echo "   1. $0 setup (–µ—Å–ª–∏ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ)"
    echo "   2. $0 generate '–¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è'"
    echo "   3. $0 export (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)"
}

case "$1" in
    setup)
        setup_venv
        ;;
    generate)
        generate_schedule "$2"
        ;;
    export)
        export_ics
        ;;
    status)
        check_status
        ;;
    help|*)
        show_help
        ;;
esac